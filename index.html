<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <title>formrunクエスト</title>
    <style>
        body {
            margin: 0;
            background: black;
            color: white;
            font-family: 'MS Gothic', monospace;
        }

        #game {
            width: 512px;
            height: 480px;
            image-rendering: pixelated;
            margin: 40px auto;
            border: 4px solid white;
            position: relative;
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        #titleScreen,
        #quizScreen,
        #resultScreen,
        #quizIntroScreen {
            position: absolute;
            top: 0;
            width: 100%;
            height: 100%;
            text-align: center;
            background: black;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #titleScreen h1 {
            font-size: 28px;
            color: yellow;
        }

        .quiz-box {
            background-color: #222;
            border: 2px solid #aaa;
            border-radius: 10px;
            padding: 16px;
            width: 80%;
            margin-bottom: 20px;
        }

        .option-box {
            background-color: #111;
            border: 1px solid #666;
            border-radius: 10px;
            padding: 10px;
            margin: 6px 0;
            text-align: left;
            width: 80%;
        }

        .selected {
            background-color: #333;
        }
    </style>
</head>

<body>
    <div id="game">
        <canvas id="gameCanvas" width="512" height="480"></canvas>
        <div id="titleScreen">
            <h1>formrunクエスト</h1>
            ▶ はじめから（スペースキー）
        </div>
        <div id="quizIntroScreen" style="display:none;">
            <h2>突然ですがクイズです！</h2>
            <p>スペースキーでスタート</p>
        </div>
        <div id="quizScreen" style="display:none;"></div>
        <div id="resultScreen" style="display:none;"></div>
    </div>

    <script>
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        const tileSize = 32;
        const player = { x: 4, y: 4 };
        const roomMap = [
            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
            [1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
        ];
        let gameStarted = false;
        let inQuiz = false;
        let quizIntro = false;
        let currentQuizIndex = 0;
        let correctCount = 0;

        const quizData = [
            {
                q: "formrunの北極星はなんでしょう",
                options: ["全てのフォームをformrunへ", "全ての打球をホームランへ", "全ての日程調整をbookrunへ"],
                answer: 0
            },
            {
                q: "「formrun」が目指したい状況はなんですか",
                options: ["海外進出", "「国産フォームといえばformrun」", "株価上昇"],
                answer: 1
            },
            {
                q: "UIUX刷新PJは何を目的としたプロジェクトですか？",
                options: ["新機能の追加", "formrun全体のUIUX刷新", "広告戦略の変更"],
                answer: 1
            }
        ];

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function startQuiz() {
            quizIntro = false;
            inQuiz = true;
            document.getElementById("quizIntroScreen").style.display = "none";
            document.getElementById("quizScreen").style.display = "flex";
            shuffle(quizData);
            currentQuizIndex = 0;
            correctCount = 0;
            renderQuiz();
        }

        function renderQuiz() {
            const quiz = quizData[currentQuizIndex];
            const container = document.getElementById("quizScreen");
            container.innerHTML = `
    <div class="quiz-box">
      <h2>${quiz.q}</h2>
    </div>
    ` + quiz.options.map((opt, i) =>
                `<div class="option-box">[${i + 1}] ${opt}</div>`
            ).join('') + `<p>1〜3キーで回答</p>`;
        }

        function finishQuiz() {
            document.getElementById("quizScreen").style.display = "none";
            const result = document.getElementById("resultScreen");
            result.innerHTML = `<h2>${correctCount}問正解！</h2><h2>おわり</h2><p>RPG？そこになければ無いですね</p>`;
            result.style.display = "flex";
        }

        function handleQuizKey(e) {
            const quiz = quizData[currentQuizIndex];
            const key = e.key;
            if (["1", "2", "3"].includes(key)) {
                const selectedOption = parseInt(key) - 1;
                const container = document.getElementById("quizScreen");
                const isCorrect = selectedOption === quiz.answer;
                if (isCorrect) correctCount++;
                container.innerHTML += `<p>${isCorrect ? '正解！' : `不正解！ 正解は [${quiz.answer + 1}] ${quiz.options[quiz.answer]}`}</p>`;
                setTimeout(() => {
                    currentQuizIndex++;
                    if (currentQuizIndex < quizData.length) {
                        renderQuiz();
                    } else {
                        finishQuiz();
                    }
                }, 1500);
            }
        }

        function drawTile(x, y, tile) {
            ctx.fillStyle = tile === 1 ? "#777" : tile === 0 ? "#b97a57" : "#999";
            ctx.fillRect(x * tileSize, y * tileSize, tileSize, tileSize);
        }

        function drawMap() {
            for (let y = 0; y < roomMap.length; y++) {
                for (let x = 0; x < roomMap[0].length; x++) {
                    drawTile(x, y, roomMap[y][x]);
                }
            }
        }

        function drawPlayer() {
            ctx.fillStyle = "#0ff";
            ctx.fillRect(player.x * tileSize, player.y * tileSize, tileSize, tileSize);
        }

        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawMap();
            drawPlayer();
        }

        function canMove(x, y) {
            return roomMap[y] && roomMap[y][x] !== undefined && roomMap[y][x] !== 1;
        }

        window.addEventListener("keydown", (e) => {
            if (!gameStarted) {
                if (e.code === "Space") {
                    document.getElementById("titleScreen").style.display = "none";
                    gameStarted = true;
                    render();
                }
                return;
            }

            if (quizIntro) {
                if (e.code === "Space") {
                    startQuiz();
                }
                return;
            }

            if (inQuiz) return handleQuizKey(e);

            let dx = 0, dy = 0;
            if (e.code === "ArrowUp") dy = -1;
            else if (e.code === "ArrowDown") dy = 1;
            else if (e.code === "ArrowLeft") dx = -1;
            else if (e.code === "ArrowRight") dx = 1;

            const newX = player.x + dx;
            const newY = player.y + dy;

            if (canMove(newX, newY)) {
                player.x = newX;
                player.y = newY;
                render();
            }

            if (player.y >= roomMap.length - 1) {
                quizIntro = true;
                document.getElementById("quizIntroScreen").style.display = "flex";
            }
        });
    </script>
</body>

</html>

